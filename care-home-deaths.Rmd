---
title: "Deaths in care homes"
output: github_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message = FALSE, warning = FALSE)

```

### Deaths in care homes as a proportion of all COVID19-related deaths

```{r}

library(pacman)
p_load(tidyverse)

care_homes <- read_csv("https://daisy.coronavirus.data.gov.uk/api/v1/data?filters=areaType=nation;areaName=England&structure=%7B%22areaType%22:%22areaType%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22date%22:%22date%22,%22newWeeklyNsoCareHomeDeathsByRegDate%22:%22newWeeklyNsoCareHomeDeathsByRegDate%22,%22cumWeeklyNsoCareHomeDeathsByRegDate%22:%22cumWeeklyNsoCareHomeDeathsByRegDate%22%7D&format=csv") %>%
  mutate(pod = "care_home")
 
ons_deaths <- read_csv("https://daisy.coronavirus.data.gov.uk/api/v1/data?filters=areaType=nation;areaName=England&structure=%7B%22areaType%22:%22areaType%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22date%22:%22date%22,%22newWeeklyNsoDeathsByRegDate%22:%22newWeeklyNsoDeathsByRegDate%22,%22cumWeeklyNsoDeathsByRegDate%22:%22cumWeeklyNsoDeathsByRegDate%22%7D&format=csv") %>%
  mutate(pod = "all")

deaths <- left_join(ons_deaths, care_homes, by = "date")

summary(deaths)

```

```{r}

prop_ch <- deaths %>%
  mutate(new = round(100 * newWeeklyNsoCareHomeDeathsByRegDate / newWeeklyNsoDeathsByRegDate, 2),
         cum = round(100 * cumWeeklyNsoCareHomeDeathsByRegDate / cumWeeklyNsoDeathsByRegDate, 2))

prop_ch %>%
  select(date, new, cum) %>%
  filter(date >= "2020-03-01") %>%
  ggplot(aes(date, new)) +
  geom_col() +
  geom_line(aes(date, cum)) +
  labs(title = "% total covid19 related deaths in care homes") +
  theme(plot.title.position = "plot")
```

### Lifetime positivity compared with weekly positivity

```{r}
library(devtools)
library(lubridate)

pos1 <- read_csv("https://api.coronavirus.data.gov.uk/v2/data?areaType=nation&metric=uniquePeopleTestedBySpecimenDateRollingSum&metric=uniqueCasePositivityBySpecimenDateRollingSum&format=csv")

str(data)

data1 <- read_csv("https://daisy.coronavirus.data.gov.uk/api/v1/data?filters=areaType=nation;areaName=England&structure=%7B%22areaType%22:%22areaType%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22date%22:%22date%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22,%22newPeopleTestedBySpecimenDate%22:%22newPeopleTestedBySpecimenDate%22,%22cumPeopleTestedBySpecimenDate%22:%22cumPeopleTestedBySpecimenDate%22%7D&format=csv")

pos <- data1 %>%
  mutate(date = lubridate::ymd(date)) %>%
  arrange(date) %>%
  mutate(pos =  newCasesBySpecimenDate / newPeopleTestedBySpecimenDate, 
         cumpos = cumCasesBySpecimenDate / cumPeopleTestedBySpecimenDate, 
         sevenDayPos = zoo::rollmean(pos, k = 7, align = "center", na.pad = TRUE)) %>%
  filter(date < today() - days(5))

pos %>%
  left_join(pos1) %>%
  arrange(desc(date)) %>%
  filter(date >= "2020-09-01") %>%
  mutate(post = 100 * cumpos) %>%
  select(date, post, uniqueCasePositivityBySpecimenDateRollingSum) %>%
  
  
  ggplot(aes(date, uniqueCasePositivityBySpecimenDateRollingSum)) +
  geom_line() +
  geom_smooth() +
  geom_line(aes(date, post))
```

### Cases

```{r}

cases <- read_csv("https://api.coronavirus.data.gov.uk/v2/data?areaType=nation&metric=cumCasesByPublishDate&metric=cumCasesBySpecimenDate&metric=newCasesByPublishDate&metric=newCasesBySpecimenDate&metric=newCasesBySpecimenDateDirection&format=csv")

cases %>%
  group_by(areaName) %>%
  mutate(total = sum(newCasesBySpecimenDate, na.rm = TRUE), 
         daily_pub_change = -cumCasesByPublishDate + lag(cumCasesByPublishDate), 
         daily_diff = daily_pub_change - lag(newCasesByPublishDate)) %>%
  filter(date >= "2020-09-01") %>%
  summarise(check = max(cumCasesByPublishDate, na.rm = TRUE),
            tot = sum(newCasesByPublishDate, na.rm = TRUE), 
            total) %>%
  mutate_if(is.numeric, sum) %>%
  mutate(diff = check - tot)
  
cases %>%
  filter(str_detect(areaCode, "^N"))




```

### Reporting cases and deaths

For both cases and deaths we present two figures - the number of each **reported** each day, and the number of each by the date of event.

If we take England an example, PHE receives positive test results from all the testing labs, public and private overnight each day. The number of cases reported is the difference between the number of cases in the database midnight on the day of report
