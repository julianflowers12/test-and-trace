---
title: "DSRs"
date: "`r Sys.Date()`"
author: "Julian Flowers"

---

```{r setup, include = FALSE}

knitr::opts_chunk$set(cache = TRUE,
                      message = FALSE, 
                      warning = FALSE,
                      echo = FALSE)

library(pacman)
p_load(tidyverse, devtools, plotly, readxl)

```

## Calculate dsrs for local authorities

```{r}

URL <- "https://github.com/julianflowers12/test-and-trace/blob/master/create_case_dsr.R?raw=TRUE"

source_url(URL)

test <- case_dsrs_las(area = "ltla")

tail(test$dsr)

```

### Get tiers

```{r tiers}

## get tier information

destfile <- tempfile()

curl::curl_download("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/938970/2020-11-26_COVID-19_Press_Conference_Data.xlsx", destfile = destfile)

sheets <- excel_sheets(destfile)

tiers <- read_excel(destfile, sheet = 4, skip = 3) %>%
  janitor::clean_names()


tiers





```

## DSRs

```{r}

#unique(test$dsr$areaName)

t1 <- c("Cornwall and Isles of Scilly", "Isle of Wight", "Liverpool", "Swale", "Kingston upon Hull, City of", "Manchester", "South Cambridgeshire")

dsr_tiers <- test$dsr %>%
  left_join(tiers, by = c("areaName" = "local_authority_district_april_2019_name")) 


dsr_1 <- dsr_tiers %>%
  #filter(areaName %in% t1) %>%
  ggplot(aes(date, value, group = areaName, colour = local_covid_19_tier)) +
  geom_line(show.legend = FALSE) +
  labs(y = "Standardised case rate", 
       x = "Date", 
       title = "Age standardised 7-day rolling case rates per 100,000") +
  scale_x_date(breaks = "months") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        plot.title.position = "plot", 
        panel.background = element_blank()) 

library(plotly)
ggplotly(dsr_1)
```

```{r fig.height= 14, fig.width=10}

dsr_tiers %>%
  group_by(areaName) %>%
  filter(date == max(date), !is.na(local_covid_19_tier)) %>%
  ggplot(aes(reorder(areaName, -value), value)) +
  geom_point(aes(colour = local_covid_19_tier), size = 1) +
  geom_linerange(aes(ymax = uppercl, ymin = lowercl, colour = local_covid_19_tier)) +
  coord_flip() +
  theme(axis.text = element_text(size = 6), 
        panel.background = element_blank(), 
        legend.position = "") +
  labs(x = "", y = "Rate") +
  viridis::scale_colour_viridis(discrete = TRUE, option = "D", direction = -1, name = "") +
  facet_wrap(~local_covid_19_tier, nrow = 1)





```

### 
